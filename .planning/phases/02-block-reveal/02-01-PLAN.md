---
phase: 02-block-reveal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [dist/global.js, dist/core.js]
autonomous: false

must_haves:
  truths:
    - "Developer can call WFApp.global.blockReveal() to create grid overlay that fades cells in randomized/staggered order"
    - "Developer can call BWBlockReveal.coverAndReveal() to hide image, run block reveal, then show image matching bw24 behavior"
    - "Block reveal re-runs correctly after navigating to page, leaving, and returning"
    - "Navigating away during block reveal animation cancels cleanly with no orphaned DOM elements or timers"
    - "window.BWBlockReveal exists for backward compatibility with Home.js calls"
  artifacts:
    - path: "dist/global.js"
      provides: "BWBlockReveal IIFE with blockReveal, coverAndReveal, cleanupAll"
      contains: "BWBlockReveal"
    - path: "dist/core.js"
      provides: "Barba beforeLeave hook calling BWBlockReveal.cleanupAll()"
      contains: "cleanupAll"
  key_links:
    - from: "dist/global.js"
      to: "window.BWBlockReveal"
      via: "IIFE assignment at module end"
      pattern: "window\\.BWBlockReveal"
    - from: "dist/global.js"
      to: "WFApp.global.blockReveal"
      via: "property assignment after IIFE"
      pattern: "WFApp\\.global\\.blockReveal"
    - from: "dist/core.js"
      to: "BWBlockReveal.cleanupAll"
      via: "barba.hooks.beforeLeave callback"
      pattern: "BWBlockReveal.*cleanupAll"
    - from: "dist/pages/Home.js"
      to: "window.BWBlockReveal.coverAndReveal"
      via: "Swiper callback (existing consumer, lines 280-312)"
      pattern: "BWBlockReveal\\.coverAndReveal"
---

<objective>
Port BWBlockReveal image animation utility from bw24/bw-blockreveal.js into global.js and wire Barba lifecycle cleanup in core.js.

Purpose: BWBlockReveal is the project's signature visual effect -- a grid overlay that fades out cells in clustered/staggered order to reveal images underneath. Home.js already calls window.BWBlockReveal.coverAndReveal() (lines 280-312) but the utility does not exist yet, so those calls silently fail. This plan implements the utility and ensures it survives Barba navigations cleanly.

Output: BWBlockReveal available via WFApp.global.blockReveal(), WFApp.global.coverAndReveal(), and window.BWBlockReveal for backward compatibility. Active reveals cancel on navigation via Barba beforeLeave hook.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-block-reveal/02-RESEARCH.md

# Phase 1 summaries -- needed for Barba hook patterns and scoped cleanup conventions
@.planning/phases/01-nav-persistence/01-01-SUMMARY.md
@.planning/phases/01-nav-persistence/01-02-SUMMARY.md

# Source files to modify
@dist/global.js
@dist/core.js

# bw24 reference implementation -- the original being ported
@../bw24/bw-blockreveal.js

# Existing consumer -- Home.js already calls BWBlockReveal.coverAndReveal
@dist/pages/Home.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement BWBlockReveal IIFE in global.js</name>
  <files>dist/global.js</files>
  <action>
Port bw24/bw-blockreveal.js into global.js as a BWBlockReveal IIFE module, placed AFTER the blocks background section (after line 536, before the menu helpers section). The implementation must be ES5-compatible (no const/let, no arrow functions, no nullish coalescing, no template literals, no destructuring) to match the existing codebase conventions.

**Structure the IIFE as:**

```javascript
// ---- Block Reveal Overlay (ported from bw24/bw-blockreveal.js) ----
var BWBlockReveal = (function () {
  'use strict';
  var activeReveals = [];
  // ... functions ...
  return { blockReveal: blockReveal, coverAndReveal: coverAndReveal, cleanupAll: cleanupAll, cssVarToPx: cssVarToPx };
})();
```

**Port these functions from bw24/bw-blockreveal.js, converting ES6 to ES5:**

1. **cssVarToPx(varName, fallbackPx)** -- Reads CSS custom property, converts rem/px/unitless to px value. Use the exact bw24 logic (lines 8-30) but with `var` instead of `const`, and `try { } catch (_) { }` instead of bare `catch`.

2. **ensureStyles()** -- Injects a style element with id "bw-blockreveal-style" once with `.bw-blockreveal__grid` and `.bw-blockreveal__cell` CSS rules. Use string concatenation instead of template literals. Use the exact bw24 CSS rules (line 36-39): grid uses `position:absolute;inset:0;pointer-events:none;z-index:9999;display:grid`, cells use `background:var(--theme--gradient);opacity:1;will-change:opacity`.

3. **blockReveal(container, opts)** -- The core grid reveal function. Port from bw24 lines 47-170:
   - Read options with fallback: `var px = (opts.px !== undefined && opts.px !== null) ? opts.px : 32;` (for each option: px, min, max, baseStagger, fadeMs, burstEvery, burstDelay, holdMs, clusterCount, clusterRadius, blinkMs)
   - Remove old grid if present: `var old = container.querySelector('.bw-blockreveal__grid'); if (old) old.remove();`
   - Set container position:relative if static
   - Calculate cols/rows: `Math.max(min, Math.min(max, Math.round(rect.width / px)))` and same for rows
   - Create grid div with CSS Grid: `grid.style.gridTemplateColumns = 'repeat(' + cols + ', 1fr)'` and same for rows
   - Generate cells in a loop, append to grid
   - Fisher-Yates shuffle for randomized order
   - **Cluster blink effect** (bw24 lines 127-148): During the hold window, pick random cluster centers, get adjacent cells within clusterRadius, and briefly flash them to opacity 0.25 then back to 1. Track ALL setTimeout IDs in a `timers` array.
   - **Fade out** (bw24 lines 151-161): After holdMs, fade cells out in shuffled order with burst groups (every burstEvery cells, add burstDelay). Use setTimeout + CSS transition (matching bw24 approach). Track ALL timer IDs.
   - **Cleanup delay** (bw24 lines 163-169): Calculate total animation duration, then setTimeout to remove grid. Track this timer ID too.
   - **Return a handle object:** `{ cleanup: cleanup, timers: timers }` where cleanup() calls `clearTimeout` on all tracked timers AND removes the grid overlay from DOM.
   - **Register handle in activeReveals array** for global cleanup.

4. **coverAndReveal(params)** -- Wrapper that hides image, runs blockReveal, shows image. Port from bw24 lines 176-212:
   - Extract slideOrContainer, containerSelector (default '.layout_team_visual_wrap'), imgSelector (default '.layout_team_visual_wrap > img.image')
   - Set container position:relative if static
   - Hide image: `img.style.transition = 'none'; img.style.opacity = '0';`
   - Calculate mobile-aware block size using cssVarToPx and matchMedia
   - Call blockReveal with the wrapper and forwarded options
   - Show image next frame: `requestAnimationFrame(function() { img.style.transition = 'opacity 90ms linear'; img.style.opacity = '1'; })`
   - Return the blockReveal handle

5. **cleanupAll()** -- Cancel all active reveals. Iterate a COPY of activeReveals (`.slice()`), call each handle's cleanup(), then empty the array.

6. **removeFromRegistry(handle)** -- Remove a specific handle from activeReveals by index.

**After the IIFE, wire into WFApp:**

```javascript
// Expose on WFApp.global
WFApp.global.blockReveal = BWBlockReveal.blockReveal;
WFApp.global.coverAndReveal = BWBlockReveal.coverAndReveal;

// Expose on window for backward compat (Home.js expects window.BWBlockReveal)
if (!window.BWBlockReveal) window.BWBlockReveal = BWBlockReveal;
```

**IMPORTANT implementation notes:**
- Use CSS transition + setTimeout for cell fades (matching bw24 exactly), NOT GSAP timeline. The bw24 reference uses pure CSS transitions, and the research recommendation to use GSAP was based on incomplete analysis of the bw24 source. Fidelity to bw24 behavior is the priority.
- Track EVERY setTimeout in a timers array so cleanup can clearTimeout on all of them.
- The cleanup function must: (a) clearTimeout on all timers, (b) remove .bw-blockreveal__grid from DOM, (c) remove handle from activeReveals registry.
- The bw24 approach uses CSS Grid layout (not position:absolute cells) -- follow this pattern exactly.
- Cell background uses `var(--theme--gradient)` to match the site's theme system.
- The `min`/`max` options clamp the number of columns/rows (not cells) to prevent tiny grids or massive ones.
  </action>
  <verify>
1. Search global.js for "BWBlockReveal" -- should find the IIFE declaration, WFApp.global assignments, and window.BWBlockReveal assignment.
2. Search global.js for "cleanupAll" -- should find the function definition and the return object.
3. Search global.js for "coverAndReveal" -- should find both the function definition and the WFApp.global assignment.
4. Verify no ES6 syntax: search for "const ", "let ", "=>", template literal backticks -- should find zero matches within the BWBlockReveal section.
5. Verify the ensureStyles function creates the style element with id "bw-blockreveal-style".
6. Verify activeReveals registry pattern exists.
  </verify>
  <done>
BWBlockReveal IIFE exists in global.js with blockReveal(), coverAndReveal(), cleanupAll(), cssVarToPx() functions. All exposed on WFApp.global and window.BWBlockReveal. Uses ES5 syntax throughout. Tracks all timers for cleanup. Matches bw24 behavior (CSS Grid layout, CSS transitions for fades, cluster blink effect, burst stagger pattern).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Barba beforeLeave cleanup in core.js</name>
  <files>dist/core.js</files>
  <action>
Add BWBlockReveal.cleanupAll() call to core.js so active block reveal animations are cancelled when the user navigates away mid-animation. This prevents orphaned DOM overlays and stale setTimeout callbacks firing after the container is swapped.

**Add to the existing `leave(data)` hook in core.js**, near the top of the leave handler (around line 838, after the menu close call but before ensureTransitionVisible). Insert:

```javascript
// Cancel any active block reveal animations before navigation
// (prevents orphaned grid overlays and stale timer callbacks)
try {
  if (window.BWBlockReveal && typeof window.BWBlockReveal.cleanupAll === 'function') {
    window.BWBlockReveal.cleanupAll();
  }
} catch (_) {}
```

**Why in leave() and not beforeLeave():** The leave hook is where all other cleanup happens (menu close, ScrollTrigger kill, controller unmount). Placing it here keeps cleanup logic consolidated and ensures it runs in the correct order -- before the container is hidden and swapped.

**Do NOT add cleanup to beforeEnter or afterEnter** -- the leave hook is sufficient. Cleanup must happen once, early, before the DOM swap.

**Do NOT modify the `once()` hook** -- block reveal is not active during initial page load (no prior navigation to cancel).
  </action>
  <verify>
1. Search core.js for "BWBlockReveal" -- should find the cleanupAll call in the leave hook.
2. Search core.js for "cleanupAll" -- should find exactly one occurrence in the leave handler.
3. Verify the call is wrapped in try/catch with null check on window.BWBlockReveal.
4. Verify placement is inside the `async leave(data)` function, before `killScrollTriggersIn`.
  </verify>
  <done>
core.js leave hook calls BWBlockReveal.cleanupAll() to cancel active reveals during navigation. Call is defensive (try/catch, null check). No orphaned grid overlays or timer callbacks survive page transitions.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify block reveal animation in browser</name>
  <action>
Human verification checkpoint. Update jsDelivr commit hash in Webflow Site Settings and verify block reveal animation works correctly in the browser.
  </action>
  <verify>
All 7 verification steps below pass without issues.
  </verify>
  <done>
Block reveal animation confirmed working: grid overlay visible on Swiper slide changes, cells blink and fade in staggered order, mid-navigation cleanup works, 10+ navigations show no accumulation, API accessible on window and WFApp.global.
  </done>
  <what-built>
BWBlockReveal utility integrated into global.js with Barba lifecycle cleanup in core.js. The grid overlay animation creates cells that blink and fade out in staggered order to reveal images. Cleanup cancels all active animations on navigation.
  </what-built>
  <how-to-verify>
1. **Update jsDelivr commit hash** in Webflow Site Settings to point to the latest commit
2. **Navigate to Home page** -- the team section Swiper should now show block reveal animations on slide change (previously the BWBlockReveal calls in Home.js silently failed)
3. **Test slide changes** -- click through the team Swiper slides. Each slide change should:
   - Briefly show a solid grid overlay (matching the site's gradient theme color)
   - Grid cells should blink in clusters during the hold period
   - Grid cells should fade out in randomized/staggered order (not linear left-to-right)
   - After grid fades, the team member image should be visible
4. **Test mid-animation navigation** -- while a block reveal is animating, click a nav link to another page. Then:
   - Check DevTools Console for errors (should be none)
   - Navigate back to Home and verify the Swiper still works
   - Repeat 5 times to confirm no accumulation of orphaned overlays
5. **Test 10+ navigations** -- navigate away from Home and back 10 times in succession:
   - Block reveal should fire on each visit (Swiper init callback triggers it)
   - No console errors accumulate
   - DOM inspector shows no leftover `.bw-blockreveal__grid` elements outside the current page
6. **Open DevTools Console and run:** `window.BWBlockReveal` -- should return an object with blockReveal, coverAndReveal, cleanupAll methods
7. **Open DevTools Console and run:** `WFApp.global.blockReveal` -- should return a function
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Phase 2 Block Reveal verification checks:

1. **BREV-01:** WFApp.global.blockReveal exists and is a function
2. **BREV-02:** blockReveal creates CSS Grid overlay, cells fade in randomized/staggered order with cluster blinks
3. **BREV-03:** coverAndReveal hides image, runs blockReveal, shows image after grid fades
4. **BREV-04:** Block reveal re-runs after Barba navigation (Home Swiper triggers it each visit)
5. **BREV-05:** Navigating mid-animation cancels cleanly (no console errors, no orphaned DOM)
6. **BREV-06:** window.BWBlockReveal exists with blockReveal, coverAndReveal, cleanupAll methods
</verification>

<success_criteria>
- Home.js Swiper team section shows block reveal animation on slide change
- Block reveal uses CSS Grid layout with themed gradient cells
- Cells blink in clusters during hold period, then fade out in staggered/burst pattern
- Navigating away mid-animation produces no console errors and no orphaned DOM
- 10+ repeated navigations to/from Home show consistent behavior with no accumulation
- window.BWBlockReveal and WFApp.global.blockReveal both accessible from DevTools console
</success_criteria>

<output>
After completion, create `.planning/phases/02-block-reveal/02-01-SUMMARY.md`
</output>
