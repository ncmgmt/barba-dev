---
phase: 01-nav-persistence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - dist/core.js
autonomous: true

must_haves:
  truths:
    - "Nav bar (.layout_nav_wrap) remains in DOM outside Barba container after every internal navigation"
    - "Footer (.footer) remains in DOM outside Barba container after every internal navigation"
    - "Transition overlay (.layout_transition_wrap) remains in DOM outside Barba container after every internal navigation"
    - "No duplicate nav/footer/overlay elements exist in DOM after navigation"
    - "Initial hard page load shows nav/footer/overlay with no flicker or regression"
  artifacts:
    - path: "dist/core.js"
      provides: "Fixed persistOutsideContainer with correct selectors, defensive re-persistence in after hook, duplicate element removal from incoming HTML"
      contains: "layout_nav_wrap"
  key_links:
    - from: "persistOutsideContainer()"
      to: "barba.init()"
      via: "called before barba.init() in init()"
      pattern: "persistOutsideContainer.*layout_nav_wrap"
    - from: "after hook"
      to: "persistOutsideContainer()"
      via: "defensive re-persistence after each navigation"
      pattern: "after.*persistOutsideContainer"
    - from: "afterLeave/beforeEnter hook"
      to: "duplicate nav removal"
      via: "remove nav/footer/overlay from incoming container HTML"
      pattern: "removeDuplicatePersisted"
---

<objective>
Fix the DOM persistence of nav, footer, and transition overlay across Barba.js page transitions.

Purpose: The nav/footer/overlay disappear after internal navigation because (1) the selector list in persistOutsideContainer() is missing `.layout_nav_wrap` (the actual Webflow class), (2) there is no defensive re-persistence after Barba swaps in new HTML that contains duplicate nav/footer elements, and (3) the overlay is moved to document.body instead of the Barba wrapper, creating inconsistency. This plan fixes all three root causes.

Output: Updated dist/core.js with robust DOM persistence that survives unlimited navigations.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-nav-persistence/01-RESEARCH.md
@dist/core.js
@dist/global.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix persistOutsideContainer selectors and overlay placement</name>
  <files>dist/core.js</files>
  <action>
In dist/core.js, make these specific changes:

1. **Fix the selector list in init() (lines 683-691)**: The current call to `persistOutsideContainer()` uses selectors `['nav', '.w-nav', '.navbar', '.nav', 'footer', '.footer']` but the actual Webflow classes are `.layout_nav_wrap` for nav and `.footer` for footer. Update the selector list to:
```javascript
persistOutsideContainer([
  '.layout_nav_wrap',
  'nav',
  '.w-nav',
  'footer',
  '.footer'
]);
```
Remove `.navbar` and `.nav` (these are too generic and risk moving unintended elements). Add `.layout_nav_wrap` as FIRST selector since it is the primary nav wrapper class used in this Webflow project.

2. **Fix persistTransitionOverlay() (lines 642-651)**: Currently moves the overlay to `document.body`, but all other persistent elements are placed inside the `[data-barba="wrapper"]`. Change it to move the overlay into the wrapper (before the container) for consistency:
```javascript
function persistTransitionOverlay() {
  try {
    var overlay = qs(CONFIG.transitionWrapSelector);
    if (!overlay) return;
    var container = document.querySelector('[data-barba="container"]');
    var wrapper = document.querySelector('[data-barba="wrapper"]');
    if (!wrapper) return;
    // If overlay is inside the container (would get swapped), move it to wrapper
    if (container && container.contains(overlay)) {
      wrapper.insertBefore(overlay, container);
    }
  } catch (_) {}
}
```
This ensures the overlay is inside the wrapper but outside the container, consistent with how nav/footer are handled. Do NOT move to document.body (it breaks the Barba wrapper structure).

3. **Call persistOutsideContainer and persistTransitionOverlay BEFORE barba.init()**: Verify the existing call order in init() already does this (lines 682-692). It does -- no change needed here, just verify during implementation.
  </action>
  <verify>
Read dist/core.js and confirm:
- persistOutsideContainer call includes '.layout_nav_wrap' as first selector
- persistTransitionOverlay moves overlay to wrapper (not document.body)
- Both functions are called before barba.init() in the init() function
  </verify>
  <done>
persistOutsideContainer uses correct Webflow selectors including .layout_nav_wrap, and persistTransitionOverlay places overlay inside wrapper (before container) instead of document.body.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add defensive re-persistence and duplicate removal in Barba hooks</name>
  <files>dist/core.js</files>
  <action>
In dist/core.js, add two defensive mechanisms to handle the case where fetched HTML contains duplicate nav/footer/overlay elements inside the new Barba container:

1. **Add a removeDuplicatePersisted() function** (place near persistOutsideContainer around line 640):
```javascript
// After Barba swaps in new HTML, the incoming container may include duplicate
// nav/footer/overlay elements (because the source pages have them in their HTML).
// Remove any duplicates that ended up inside the container to prevent doubling.
function removeDuplicatePersisted(container) {
  if (!container) return;
  var selectors = [
    CONFIG.transitionWrapSelector,
    '.layout_nav_wrap',
    'nav',
    '.w-nav',
    'footer',
    '.footer'
  ];
  selectors.forEach(function (sel) {
    try {
      var dupes = container.querySelectorAll(sel);
      for (var i = 0; i < dupes.length; i++) {
        try { dupes[i].remove(); } catch (_) {}
      }
    } catch (_) {}
  });
}
```

2. **Call removeDuplicatePersisted in beforeEnter hook** (after IX2 reinit, around line 855):
After the `reinitWebflowIX2()` call in `beforeEnter`, add:
```javascript
// Remove duplicate nav/footer/overlay from incoming container.
// The source page HTML includes these elements, but we already have
// the persisted originals outside the container.
try { removeDuplicatePersisted(data && data.next && data.next.container); } catch (_) {}
```

3. **Add defensive re-persistence in the after hook** (around line 933, before tryGlobalAfterEnter):
```javascript
// Defensive re-persistence: ensure persistent elements are still outside container.
// This catches edge cases where Barba's DOM manipulation may have moved them.
try {
  persistTransitionOverlay();
  persistOutsideContainer([
    '.layout_nav_wrap',
    'nav',
    '.w-nav',
    'footer',
    '.footer'
  ]);
} catch (_) {}
```

IMPORTANT: The re-persistence in `after` must happen BEFORE `tryGlobalAfterEnter(data)` because global.afterEnter re-initializes nav scroll triggers that depend on nav being in the correct DOM position.

IMPORTANT: Do NOT call removeDuplicatePersisted on the document root -- only on the incoming container. Removing from the root would kill the persisted originals.
  </action>
  <verify>
Read dist/core.js and confirm:
- removeDuplicatePersisted function exists and operates only within a given container element
- beforeEnter hook calls removeDuplicatePersisted(data.next.container)
- after hook calls persistTransitionOverlay() and persistOutsideContainer() before tryGlobalAfterEnter()
- The selectors used in re-persistence match the selectors used in initial persistence
  </verify>
  <done>
Incoming container's duplicate nav/footer/overlay elements are removed before the page is revealed. Persistent elements are defensively re-checked after every navigation. No duplicate DOM elements accumulate across navigations.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. Read dist/core.js top-to-bottom for the persistence flow: init() -> persistTransitionOverlay + persistOutsideContainer (before barba.init) -> beforeEnter removes duplicates -> after re-persists
2. Confirm no duplicate selector entries
3. Confirm overlay goes to wrapper (not body)
4. Confirm removeDuplicatePersisted only operates on container, never document
</verification>

<success_criteria>
- persistOutsideContainer includes .layout_nav_wrap as first selector
- persistTransitionOverlay places overlay in wrapper before container (not body)
- removeDuplicatePersisted function exists and is called in beforeEnter
- Defensive re-persistence called in after hook before global afterEnter
- No functional regressions in transition flow (leave/enter/after hook ordering preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/01-nav-persistence/01-01-SUMMARY.md`
</output>
